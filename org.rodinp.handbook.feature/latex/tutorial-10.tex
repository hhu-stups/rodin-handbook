% We do not want to have screen shots of the celebrity puzzle in this section:
\clearpage
\section{Proving Deadlock Freeness}
\label{tut_location_access_controller}

\tick{\textbf{Goals:} In this section, we will take a closer look at a few more complex proofs. For this we use the model of a location access controller. The goal is to develop the proofs that ensure there are no deadlocks present in the initial model and in the first refinement.}

\info{\marginpar{Reference to literature section}This example has been taken from the Event-B book and is quite sophisticated.  In this section, we are concerned with a subset of the complete model.  We encourage readers to consult the example in the book.}

%\info {First of all you need to download the following \file{Doors.zip}{Location Access Controller problem}.}

Through the model used in this section, we study a complete system and remind the proof rules of formal development. The system's task is to control the access of certain people to different locations of a site. The system is thus based on whether a person has (or does not have) access to a particular location.

Before describing the initial model, import the archive file \file{Doors.zip}{Doors.zip} that contains the model. To do this, select  \textsf{File $\rangle$ Import $\rangle$ General $\rangle$ Existing Project into Workspace}. Then select the according archive file and click on \textsf{Finish}. It will take Rodin a few seconds to extract and load all the files.

\subsection{Deadlock Freeness of initial model}
\label{deadlock}
\label{tut_initial_model}

%Besides we introduce:

%\begin{itemize}
%	\item The two carrier sets of persons, P, and locations, L
%	\item The constant authorization, \textbf{aut}, representing a relation between P and L, actually where people are allowed to go %(Axiom 1).
%	\item The variable, \textbf{sit}, which denote where a person is, \textbf{sit} is a function from P to L.
%\end{itemize} 
 
%Moreover, we introduce a special constant “location”, named \textbf{outside}. Everyone is authorized to be in outside (Axiom 3) and a %person cannot be in two locations at a time. However every person, which is in a certain location, is authorized to be there.

%Initially, everyone is outside as indicated in event \textsf{INITIALISATION}.
%The other event \textsf{PASS} of that model has to aim to change the location of a person.
%We call the proof of deadlock freeness through this tutorial the proof justifying that someone can always change location.

Let us look at the initial model which consists of the context \texttt{doors\_ctx1} and the machine \texttt{doors\_0}. There are two carrier sets in the model context. One is for people ($P$) and the other is for locations ($L$). There is a location called outside ($outside$) and a relation ($aut$) which reflects where people are allowed to go. Everyone is permitted to go outside. The model machine has one event, \textsf{pass}, which changes the location of a person and one variable, $sit$, which denotes where a person is located. 


Looking through the initial model, you will see that everything already has been proved (for the initial model and initial context). This is true, but Rodin does not do any deadlock freeness proof yet, so we will have to add them by ourself. A model is considered as deadlocked if the system reaches a state with no outgoing transitions. The objective of this section is to develop proofs for deadlock freeness for the initial model and for the first refinement. 

Consider the event \textsf{pass} from the initial model:

\pencil{
\begin{description}
\EVENTS
	\EVT {pass}
		\begin{description}
		\AnyPrm
			\begin{description}
			\ItemX{ p }
			\ItemX{ l }
			\end{description}
		\WhereGrd
			\begin{description}
			\nItemX{ grd11 }{ p \mapsto  l \in  aut }
			\nItemX{ grd12 }{ sit(p) \neq  l }
			\end{description}
		\ThenAct
			\begin{description}
			\nItemX{ act11 }{ sit(p) :=  l }
			\end{description}
		\EndAct
		\end{description}
\END
\end{description}
}

\index{deadlock}
Since the initial model has only one event (\textsf{pass}), the system might deadlock when both guards of the event (\textsf{grd11} and \textsf{grd12}) are false.
In this case, to prove that no deadlocks can occur requires proving that someone can always change room.
Clearly, we want to avoid this happening. We must therefore prove that the two guards are always true. 
To do this, add a new derived invariant (a theorem) to \texttt{doors\_0} called \textsf{DLF} (click the \texttt{not theorem} button to make it switch to \texttt{theorem})
  and change the predicate so that it is the conjunction of the two guards.
The difference between a ``normal'' invariant and one that is marked as theorem is that is must be proven that the theorem always holds if the other invariants
  declared before hold.
 We do not need to prove that an event preserves the invariant marked as theorem because this is a logical consequence when it preserves the other invariants.

\begin{description}
\INVARIANTS
	\begin{description}
		\nItemX{ DLF }{ \fbox{theorem} ~ \exists p, l\qdot (p \mapsto  l \in  aut \land  sit(p) \neq  l) }
	\end{description}
\end{description}

\begin{rodin-plugin}{img/prob.png}{ProB}%
  You can also use ProB to search for deadlocks (ensure that ProR is installed).
  Right-click on the machine you want to check and start the animation with the
  ``Start Animation / Model Checking'' menu entry.
  After starting the animation, go to the Event View in the ProB perspective
  (see \ref{fig_tut_prob_perspective}).
  There are two ways to search for deadlocks:
  \begin{itemize}
  \item Just press on the \texttt{Check} button and mark \texttt{Find Deadlocks} before
    starting the check by pressing the button \texttt{Start consistency checking}.
    ProB then systematically ``executes'' all events and tries to find a state where no
    event is enabled.
  \item An alternative is to select \texttt{Deadlock Freedom Checking} after clicking
    on the triangle right to the \texttt{Check} button.
    ProB then prompts you for an optional predicate. Just leave that empty for the start.
    The difference to the first alternative is that ProB searches now for variable values
    where all invariants are true but none of the guards.
  \end{itemize}
\end{rodin-plugin}

Save the machine. We will see in the Event-B Explorer View that the auto-prover (\ref{auto_prover}) fails to prove the theorem \textsf{DLF/THM}.

\warning{If you cannot find the proof obligation \textsf{DLF/THM}, maybe you forgot to mark the invariant as a theorem by clicking on the \texttt{theorem} button.
  Another reason that you don't see the proof obligation \textsf{DLF/THM} could be that you forgot to rename the invariant ``DLF''.}

Let us analyze whether this is an inconsistency in the model. Switch to the \texttt{Proving Perspective } and double click on the proof obligation \textsf{DLF/THM}.
\index{post-tactics}
In the Proof Control view, first disable the post-tactics (there is a small downward pointing arrow in the upper right hand corner above the toolbar, see Figure~\ref{fig_tut_10_post_tactics}.
Click on this arrow and make sure that the option \textsf{Enable post-tactic} is unchecked in the dropdown menu.)
We turn off the post-tactics because we want to see the proof develop in its different stages.
Then select the root node in the \textsf{Prove Tree}, right-click on it and select \textsf{Purge}.
This removes any proof that might be already started by the auto-provers.
By doing this we want to assure that you have the same proof as in this tutorial.

\begin{figure}[!ht]
  \begin{center}
    	\includegraphics{img/tutorial/tut_10_post_tactics.png}
    \caption{Disabling the proof post-tactics in the Proof Controlling View}
    \label{fig_tut_10_post_tactics}
  \end{center}
\end{figure}

In order to succeed with the proof, we need a pair $p \mapsto l$ that is in $aut$ but not in $sit$.
Having a look the axioms, we find  \textsf{axm4} of \texttt{doors\_ctx1}, which states that 
  there is a location $l$ different from $outside$ where everyone is allowed to go:

\pencil{
\begin{description}
\AXIOMS
	\begin{description}
		\nItemX{ axm4 }{ \exists l\qdot l\in L\setminus \{ outside\}  \land  P\cprod \{ l\} \subseteq aut }
	\end{description}
\end{description}
}

So for every person $p$ in $P$, $p \mapsto l$ and $p \mapsto outside$ are in \textbf{aut}.
(In other words: every person is allowed to go both to the outside and to a location $l$).
The basic idea of our proof is that a person is either outside and can go to the location $l$.
When she is not outside, she can walk outside\footnote{One could argue that this is too restrictive in the real world: After all, why do all people need authorization for the \textit{same} location l?  But arguing about the realism of the example is out of the scope.}.

We implicitly assumed that there is actually a person, so what we need is that $P$ is non-empty. 
This holds since carrier sets are always non-empty, but we need a person as an example for our further proof. 
Now add the hypothesis $\exists x . x \in P$ using the \icon{rodin/ah_prover.png} button after entering the predicate into the \textsf{Proof Control} text area. 
In the \textsf{Proof Tree} view you can now see three new nodes that have to be proven:
\begin{itemize}
\item $\btrue$ is the trivial well-definedness condition, just click on \icon{rodin/auto_prover.png} to prove it.
\item $\exists x\qdot x\in P$ is the hypothesis that we introduced, just click on \icon{rodin/auto_prover.png} to prove it.
\item $\exists p, l\qdot (p \mapsto  l \in  aut \land  sit(p) \neq  l)$ is the original goal
  but we can use the introduced hypothesis in the proof. We now continue with the proof of this goal.
\end{itemize}

Click on the existential quantifier of the new hypothesis $\exists x \cdot x \in P$
  (appearing in the \textsf{Selected Hypothesis} view) as demonstrated in Figure \ref{fig_tut_10_instantiate_x}.
You see that it is automatically instantiated. That means that we can use $x$ from now on in our proof as an example for a person
  and we have the new hypothesis $x \in P$.

\warning{If you hover over any red symbol for a short while, a menu will pop up, offering one or more transformations.  Make sure that you actually click before the menu pops up, otherwise clicking will have no effect.  If the menu popped up before you managed to click, you just have to click twice: First to discard the menu, and another time to actually perform the clicking.}

An existential quantification can be proven by giving an example for the variables. First, we
  instantiate $p$ in the goal with $x$: enter $x$ in the yellow box corresponding to $p$ 
  in the \textsf{Goal View} and click on the existential quantifier as shown in Figure \ref{fig_tut_10_instantiate_p}. 

\begin{figure}[!ht]
\begin{center}
	\includegraphics{img/tutorial/tut_10_instantiate_x.png}
	\caption{Click on the existential quantifier in order to ...}
	\label{fig_tut_10_instantiate_x}
\end{center}
\end{figure}

\begin{figure}[!ht]
\begin{center}
	\includegraphics{img/tutorial/tut_10_instantiate_p.png}
	\caption{... instantiate it, in this case by substituting $x$.}
	\label{fig_tut_10_instantiate_p}
\end{center}
\end{figure}

% \warning{If the hypothesis does not appear immediately in the \textsf{Selected Hypothesis} view, reclick on the Auto Prover button until it does.}

The instantiation produces two new nodes in the \textsf{Proof Tree} view. The first goal is the trivial well-definedness condition $\btrue$ and
  can be easily discharged by pressing \icon{rodin/auto_prover.png}.
The remaining goal is $\exists l\qdot (x \mapsto  l \in  aut \land  sit(x) \neq l)$ which results from the old goal by replacing $p$ by $x$.
You can see the the current proof tree in Figure~\ref{fig_tut_10_proof_tree}. In the node \textsf{ah} we added the hypothesis, in \textsf{$\exists$ hyp}
  we instantiated $x$ from a hypothesis and in \textsf{$\exists$ goal} we instantiated $p$ in the goal.

\begin{figure}[!ht]
\begin{center}
	\includegraphics{img/tutorial/tut_10_proof_tree.png}
	\caption{The proof tree after instantiating $p$ with $x$.}
	\label{fig_tut_10_proof_tree}
\end{center}
\end{figure}

Now we need an example for the remaining variable $l$.
There are two situations we want to distinguish: The person $x$ could be outside or not.
To do this, type $sit(x) = outside$ into the \textsf{Proof Control} view and click on the button \icon{rodin/dc_prover.png} (\textsf{dc} for distinguish case).
Again, you get three new goals.

\begin{itemize}
\item The first is the well-definedness condition of $sit(x) = outside$. $sit$ must be a function and $x$ in its domain.
  This is easy to prove since $sit$ is a total function (\ref{relations}). Just press \icon{rodin/auto_prover.png}.
\item The second node has the original goal but $sit(x) = outside$ as a hypothesis.
\item The third node has the original goal but $\lnot sit(x) = outside$ as a hypothesis.
\end{itemize}

\warning{Note that the second and third node will appear identical in the proof tree.  You will only see the differences in the hypotheses by selecting the nodes.}

Let's continue with the case $sit(x)=outside$: When $x$ is outside, it can always go to the $l$ of \textsf{axm4}.
To search for \textsf{axm4}, type $outside$ into the \textsf{Proof Control} text field and click the button \icon{rodin/sh_prover.png}. Now click on the $\exists$ symbol in the \textsf{axm4} (see Figure~\ref{fig_tut_10_search_hypotheses})
to instantiate $l$.
Now we have $l$ as an example for a location which is not outside and where everybody can go.
\begin{figure}[!ht]
  \begin{center}
    \includegraphics{img/tutorial/tut_10_search_hyp.png}
    \caption{Searching hypothesis for $outside$: The third one is \textsf{axm4}.}
    \label{fig_tut_10_search_hypotheses}
  \end{center}
\end{figure}
Our goal still is $\exists l\qdot x\mapsto l\in aut \land sit(x)\neq l$.
Note that the existential quantification introduces a new $l$ which has not (yet) anything to do with
 our location $l$ where anybody can go.
Now type $l$ into the yellow box of the goal and press the $\exists$ symbol to state that we use our $l$ as
  an example for the $l$ in the existential quantification.
Again, we have first the trivial goal $\btrue$ as well-definedness condition, just press \icon{rodin/auto_prover.png}.
The remaining goal should be $x\mapsto l\in aut \land sit(x)\neq l$.
This can be proven by the already selected hypothesis $sit(x)=outside$, $l\in L\setminus\{outside\}$ and $P\cprod\{l\}\subseteq aut$. Just
  press \icon{rodin/auto_prover.png}.

Now our second case of the case distinction remains where $x$ is not outside ($sit(x)\neq outside$). Then $x$ can just go outside.
Again the goal is $\exists l\qdot x\mapsto l\in aut \land sit(x)\neq l$. Type
$outside$ as an example for a location $l$ into the yellow box and press
the $\exists$ symbol.
Press  \icon{rodin/auto_prover.png} to discharge the trivial well-definedness condition $\btrue$.
The new goal should be $x \mapsto outside\in aut \land sit(x)\neq outside$.

To prove this we need the information that $x$ has the right to go $outside$.
This is stated in the axiom $P \cprod\{outside\}\subseteq aut$.
Have a look at the \textsf{Search Hypothesis} view. There should be still the result from the last search for $outside$.
(If not, repeat the search by entering $outside$ into the \textsf{Proof Control} and press \icon{rodin/sh_prover.png}.)
Select $P \cprod\{outside\}\subseteq aut$ (in Figure~\ref{fig_tut_10_search_hypotheses}, it's the second entry) and
  press \icon{rodin/add.png} to add it to your selected hypothesis.
Then the auto-prover has enough information, just click \icon{rodin/auto_prover.png} and
  the last goal of our theorem should be proven.

We just summarize the proof. Compare this with your final proof tree (like in 
Figure~\ref{fig_tut_10_final_proof_tree}).

\begin{tabular}{l}
  \hline
  added hypotheses: $\exists x\qdot x\in P$ \\
  \quad well-definedness condition $\btrue$: automatically proven\\
  \quad the hypotheses: automatically proven \\
  \quad instantiation of $x$ in the hypotheses $\exists x\qdot x\in P$\\
  \qquad using $x$ as an example for the $\exists p \ldots$ in the goal\\
  \quad\qquad well-definedness condition $\btrue$: automatically proven\\
  \quad\qquad case distinction $sit(x)=outside$ \\
  \qquad\qquad well-definedness condition
    ($sit$ is a function with $x$ in its domain): \\
  \qquad\qquad\qquad\qquad\qquad\qquad automatically proven\\
  \qquad\qquad first case: instantiation of $l$ from axiom \textsf{axm4}\\
  \quad\qquad\qquad using $l$ as an example for the $\exists l \ldots$ in the goal\\
  \qquad\qquad\qquad well-definedness condition $\btrue$: automatically proven\\
  \qquad\qquad\qquad automatically proven\\
  \qquad\qquad second case: using $outside$ as an example for the $\exists l \ldots$ in the goal\\
  \quad\qquad\qquad well-definedness condition $\btrue$: automatically proven\\
  \quad\qquad\qquad hypotheses $P\cprod\{outside\}$ selected\\
  \qquad\qquad\qquad automatically proven\\
  \hline
\end{tabular}
\begin{figure}[!ht]
  \begin{center}
    \includegraphics{img/tutorial/tut_10_proof_tree_final.png}
    \caption{Searching hypothesis for $outside$: The third one is \textsf{axm4}.}
    \label{fig_tut_10_final_proof_tree}
  \end{center}
\end{figure}



\subsection{Deadlock Freeness of First Refinement}
\label{tut_location_first_refinement}

Now we are going to explain the main complexity of our model: the deadlock freeness proof for the first refinement. 

\info{Please note that post-tactics should still be disabled before starting this part of the tutorial.} 

The difference between the first refinement and the initial model is that a new constant \textsf{com} been added in order to describe which rooms are connected. Additionally, we have a constant \textsf{exit}, which provides a path for all people to get outside.  Please consult the book\marginpar{Reference to Abrial book} for the details regarding this model.

The event \textsf{INITIALISATION} does not change, but the event \textsf{PASS} is refined as a consequence. We assume that a person can move to another location l if they have the authorization to be in l (already defined in the abstraction) and also if the location l is connected to the location p where the person is at this precise moment (represented by sit(p)).

\pencil{
\begin{description}
\nItemX{ grd12 }{ sit(p)\mapsto l \in  com }
\end{description}
}

Corresponding to Section \ref{tut_initial_model}, open \texttt{door\_1} machine and add a derived invariant (theorem) called \textsf{DLF} as follows\footnote{A number of concerns can be found with this statement.  For one, it only states that at least one person can move, while it may be better to state that every person can move.  Further, this statement would not detect life locks\index{life lock}: A situation where the system oscillates between a small number of states.}: 

\pencil{
\begin{description}
	\nItemX{ DLF }{ \exists q, m \cdot (q \mapsto m \in aut \wedge sit(q) \mapsto m \in com)  }
\end{description}
}

Save the file. Once again, the prover fails to prove the deadlock freeness automatically. Stated in natural language, we want to prove is that ``at least one person authorized to be in a location must also be authorized to go in another location which communicates with the first one''.

To begin with, switch over to the proving perspective and double click on \textsf{DLF/THM} to begin proving.  How to get started?  It is often a good idea to subdivide a proof into cases.  One distinction of cases could be whether the person is outside or not.  Let's do this.

First we need a variable denoting a location, in order to distinguish two cases in the first place.  We use the deadlock freeness invariant from the initial model for this purpose.  Using the search functionality, we add it as a hypothesis, as shown in figure~\ref{tut_10_ref_proof1}.

\begin{figure}[!ht]
\begin{center}
	\includegraphics[]{img/tutorial/tut_10_ref_proof1.png}
	\caption{Adding a hypothesis to instantiate a variable for a case distinction.}
	\label{tut_10_ref_proof1}
\end{center}
\end{figure}

Now we can click on the red $\exists$ to instantiate the variables p and l, which in turn allows us to make the case distinction. To do this, we enter the following in the Proof Control View:

$$ sit(p) = outside $$

... and press \icon{rodin/dc_prover.png}.  This will create three new nodes in the proof tree: The first one being the well-definedness again, followed by the two cases.  As always, we can just dismiss the first one with \icon{rodin/auto_prover.png}.

The first case concerns $sit(p) = outside$.  We remember that \textsf{axm7} is a statement about the fact that at least one authorized room is connected to the outside:

\pencil{
\begin{description}
	\nItemX{ axm7 }{ \exists l\qdot l\in L\setminus \{ outside\}  \land  outside\mapsto l\in com \land  P\cprod \{ l\} \subseteq aut  }
\end{description}
}

We add \textsf{axm7} to the list of hypotheses.  Here, too, we would like to work with the location, so we instantiate this hypothesis, again by clicking on its red $\exists$.

\info{Note that Rodin instaniated the variable with the name $l0$, instead of $l$, as the name $l$ already exists from the previous instantiation.}

Now we have variables to instantiate our goal as well.  We enter the value $p$ in the yellow box for q and $l0$ in the yellow box for m (figure~\ref{tut_10_ref_proof2}) and press the red  $\exists$.

\begin{figure}[!ht]
\begin{center}
	\includegraphics[]{img/tutorial/tut_10_ref_proof2.png}
	\caption{Preparing the instantiation by providing values for $p$ and $l0$.}
	\label{tut_10_ref_proof2}
\end{center}
\end{figure}

This results in two new nodes to the proof tree, the first one being the well-defined proof obligation.  The last remaining proof obligation is really harmless, and intuitively understandable. Further, we can solve it with the given hypotheses.  Clicking \icon{rodin/p0.png} will discharge it.

This resolved the first case.  Now let's go to the second case, $sit(p) \neq outside$.  Again, we would like to instantiate the quantifier, but this time we have to use different values.  We still have p to substitute for q, but the location we express in terms of the exit relationship: Our axioms tell us that there is always an exit from every location, therefore $exit(sit(p))$ should be a valid substitution for m. Let's perform the substitution.  This advances our proof tree with a new node (and the well-definedness proof obligation, which we discharge with one click).

The resulting proof obligation is a conjunction.  We can discharge the two parts of it by clicking on the $\land$, resulting in two simpler goals in the proof tree.  We start with the \textbf{second} goal.

\info{We start with the second, rather than the first goal, because doing so will provide us with hypotheses that will be beneficial in discharging the first goal.  How do we know this? By experience, and by playing with the proofs for a long time.  Depressingly, there is no easy rule to guide through the proving process, just general guidelines and experience.}

The goal we start with is:

$$ sit(p) \mapsto exit(sit(p)) \in com $$

We have no hypothesis yet that contains com.  We try \textsf{axm4}:

\pencil{
\begin{description}
\nItemX{ axm4 }{ exit \subseteq  com }
\end{description}
}

We try  \icon{rodin/p0.png}, and Rodin discharges the goal.

We now approach the last undischarged goal:

$$ p \mapsto exit(sit(p)) \in aut $$

In other words, the person is authorized to follow the exit.  Again, we look through our axioms and find \textsf{axm6}, which essentially states: ``Everybody has the permission to leave from wherever they are'':

\pencil{
\begin{description}
\nItemX{ axm6 }{ aut \ransub  \{ outside\}  \subseteq  (aut ; exit^{-1} )  }
\end{description}
}

We can remove the inclusion by clicking on the red $\subseteq$, which results in a hypothesis with universal quantifier, which we can instantiate with the variables that we already have at hand.  We substitute p for x and sit(p) for x0.  Look at the formula and confirm that this makes sense.

This results in two more goals in our proof tree, the first one being well-definedness again.

The remaining goal is simple and essentially states that following the current position along the exit route will lead to a location where the user is authorized:

$$ p \subseteq exit(sit(p)) \in aut $$

We cannot discharge this with \icon{rodin/p0.png}; However, trying \icon{rodin/p1.png} will discharge it.  Using \icon{rodin/p1.png} is the same as selecting related hypotheses with \icon{rodin/lasoo_prover.png} and then using \icon{rodin/p0.png}.  The danger of this approach is that so many hypotheses are added, that the prover does not find a solution before timing out.  In this case, it worked.

\info{We leave it as an exercise to the reader to manually identify the hypotheses that are required to discharge this goal.}


This concludes the tutorial. Be aware that we just look at one small aspect of a rather sophisticated model.  Also, please be aware that this tutorial gave you only an introduction to proving.  To become an expert, we encourage you to study interesting models in the literature and to practice.

%%% Local Variables: 
%%% mode: latex
%%% TeX-master: "rodin-doc"
%%% End: 
